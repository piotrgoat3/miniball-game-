<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MiniSoccer - Szybki Mecz</title>
    <!-- Łącze do czcionki Nunito -->
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap"
        rel="stylesheet"
    />
    <style>
        /* --- GLOBALNE STYLE --- */
        :root {
            /* Domyślne rozmiary (odpowiadające średniej) */
            --font-size-h1: 56px;
            --font-size-h2: 40px;
            --font-size-h3: 28px;
            --font-size-button: 20px;
            --font-size-button-padding: 15px 30px;
            --font-size-small-button: 18px;
            --font-size-small-button-padding: 10px 20px;
            --font-size-team-option: 1rem; /* Domyślny rozmiar tekstu */
            --font-size-scoreboard: 28px;
            --font-size-timer: 20px;
        }

        body {
            font-family: "Nunito", sans-serif;
            background: url("https://images.unsplash.com/photo-1578985545062-69928b1d9587?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80")
                no-repeat center center fixed;
            background-size: cover;
            margin: 0;
            padding: 0;
            text-align: center;
            color: #fff;
            font-size: var(--font-size-team-option); /* Używamy zmiennej CSS dla bazowego rozmiaru */
            transition: font-size 0.3s ease; /* Płynne przejście przy zmianie rozmiaru */
        }
        body::before {
            content: "";
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); z-index: -1;
        }
        .hidden { display: none !important; }

        /* --- STYLOWANIE DLA RÓŻNYCH ROZMIARÓW CZCIONEK --- */
        body.font-size-small { --font-size-h1: 48px; --font-size-h2: 34px; --font-size-h3: 24px; --font-size-button: 18px; --font-size-button-padding: 12px 25px; --font-size-small-button: 16px; --font-size-small-button-padding: 8px 16px; --font-size-team-option: 0.9rem; --font-size-scoreboard: 24px; --font-size-timer: 18px; }
        body.font-size-medium { /* Domyślne wartości są już w :root */ }
        body.font-size-large { --font-size-h1: 64px; --font-size-h2: 46px; --font-size-h3: 32px; --font-size-button: 22px; --font-size-button-padding: 18px 35px; --font-size-small-button: 20px; --font-size-small-button-padding: 12px 25px; --font-size-team-option: 1.1rem; --font-size-scoreboard: 32px; --font-size-timer: 22px; }

        /* --- EKRAN STARTOWY --- */
        #startScreen { padding: 40px 20px; }
        #startScreen h1 {
            font-size: var(--font-size-h1); margin-bottom: 30px;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }
        #startScreen button {
            font-size: var(--font-size-button); padding: var(--font-size-button-padding); margin: 15px;
            border: none; border-radius: 10px; background-color: rgba(255,255,255,0.8);
            cursor: pointer; color: #333; box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        #startScreen button:hover {
            background-color: #fff; transform: scale(1.05);
            box-shadow: 0px 5px 15px rgba(0,0,0,0.3);
        }
        .start-options button {
             font-size: var(--font-size-small-button); padding: var(--font-size-small-button-padding);
        }

        /* --- EKRAN WYBORU DRUŻYN --- */
        #teamSelectScreen { padding: 40px 20px; }
        #teamSelectScreen h2 {
            font-size: var(--font-size-h2); margin-bottom: 20px;
            text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
        }
        .team-section { margin: 30px auto; max-width: 800px; text-align: left; }
        .team-section h3 { font-size: var(--font-size-h3); margin-bottom: 15px; padding-left: 10px; }
        .team-container { display: flex; gap: 20px; overflow-x: auto; padding: 10px; scrollbar-width: thin; }
        .team-container::-webkit-scrollbar { height: 8px; }
        .team-container::-webkit-scrollbar-thumb { background: #ffd700; border-radius: 4px; }
        .team-option {
            cursor: pointer; text-align: center; border: 2px solid rgba(255,255,255,0.5);
            border-radius: 12px; width: 150px; padding: 10px; transition: all 0.3s ease;
            flex: 0 0 auto; font-size: var(--font-size-team-option); /* Rozmiar tekstu nazwy drużyny */
        }
        .team-option.selected { border-color: #ffd700; transform: scale(1.1); background-color: rgba(255,255,255,0.2); }
        .team-option img { width: 80px; height: 80px; display: block; margin: 0 auto 10px; }
        .league-header { display: flex; align-items: center; gap: 5px; margin-bottom: 10px; padding-left: 10px; }
        .league-header img { width: 30px; height: 30px; }
        #startMatchFromSelectBtn {
            font-size: var(--font-size-button); padding: var(--font-size-button-padding); margin-top: 30px; cursor: pointer;
            background-color: rgba(255,255,255,0.9); border: none; border-radius: 12px;
            transition: all 0.3s ease; box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
        }
        #startMatchFromSelectBtn:hover { background-color: #fff; transform: scale(1.05); box-shadow: 0px 5px 15px rgba(0,0,0,0.3); }

        /* --- EKRAN GRY --- */
        #gameScreen { padding: 20px; }
        #scoreboardContainer { margin-bottom: 20px; }
        #scoreboard { font-size: var(--font-size-scoreboard); font-weight: bold; }
        #matchTimer { font-size: var(--font-size-timer); margin-top: 5px; }
        canvas {
            background-color: #228B22; border: 4px solid #fff; border-radius: 16px;
            display: block; margin: 0 auto; box-shadow: 0px 8px 16px rgba(0,0,0,0.35);
        }
        #backToStartBtn {
            font-size: var(--font-size-small-button); padding: var(--font-size-small-button-padding); margin-top: 20px; cursor: pointer;
            background: rgba(255,255,255,0.9); border: none; border-radius: 10px;
            transition: background 0.3s; box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
        }
        #backToStartBtn:hover { background: rgba(255,255,255,1); }

        /* --- MODALE --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: flex; align-items: center;
            justify-content: center; z-index: 100; animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content {
            background: #fff; padding: 30px; width: 90%; max-width: 500px;
            border-radius: 16px; box-shadow: 0 8px 16px rgba(0,0,0,0.35);
            color: #333;
        }
        .modal-content h2 { margin-top: 0; font-size: var(--font-size-h3); } /* Użycie zmiennej */
        .modal-content h3 { font-size: calc(var(--font-size-h3) * 0.8); } /* Dostosowanie */
        .modal-content p { font-size: var(--font-size-team-option); } /* Użycie zmiennej */
        .modal-content button {
            font-size: var(--font-size-small-button); /* Użycie zmiennej */
            padding: var(--font-size-small-button-padding); /* Użycie zmiennej */
            background: rgba(50, 150, 50, 0.8); /* Lekko zielony */
            border: none; border-radius: 6px; margin-top: 10px; margin-right: 5px; /* Dodano margines */
            transition: background 0.3s, transform 0.2s;
            box-shadow: 0px 2px 4px rgba(0,0,0,0.25); cursor: pointer; color: white; /* Biały tekst */
        }
        .modal-content button:hover {
            background: rgba(30, 120, 30, 1); /* Ciemniejszy zielony */
            transform: translateY(-2px);
        }
        /* Specyficzny styl dla przycisku zamknięcia */
        .modal-content button.close-btn {
             background: rgba(200, 50, 50, 0.8); /* Czerwony */
        }
         .modal-content button.close-btn:hover {
             background: rgba(170, 30, 30, 1); /* Ciemniejszy czerwony */
        }
        /* Aktywny przycisk rozmiaru czcionki */
        .modal-content button.active-size {
             background: rgba(30, 120, 30, 1); /* Ciemniejszy zielony dla aktywnego */
             box-shadow: inset 0px 2px 4px rgba(0,0,0,0.3);
        }
        input {
            border: 1px solid #ccc; border-radius: 6px; padding: 10px;
            margin: 5px 0; width: calc(100% - 22px); /* Dostosowanie szerokości */
            box-sizing: border-box; font-size: var(--font-size-team-option); /* Użycie zmiennej */
        }
        #playerList {
            max-height: 300px; overflow-y: auto; scrollbar-width: thin;
            scrollbar-color: #185c28 #ffffff; margin-bottom: 15px; /* Dodano margines */
            font-size: var(--font-size-team-option); /* Użycie zmiennej */
        }
        #playerList::-webkit-scrollbar { width: 8px; }
        #playerList::-webkit-scrollbar-thumb { background: #185c28; border-radius: 5px; }
        #playerList::-webkit-scrollbar-track { background: #ffffff; }
        #addPlayerForm button { /* Zastosuj zielony styl do przycisku Dodaj */
             margin-top: 10px; margin-right: 0; /* Reset marginesu dla tego przycisku */
        }
        .font-size-options { margin-top: 15px; margin-bottom: 20px; } /* Odstępy dla opcji czcionki */
    </style>
</head>
<body class="font-size-medium"> <!-- Domyślnie średnia czcionka -->
    <!-- EKRAN STARTOWY -->
    <div id="startScreen">
        <h1>MiniSoccer ⚽</h1>
        <button id="startMatchBtn">SZYBKI MECZ</button>
        <div class="start-options">
            <button id="btnPlayerDB">Baza zawodników</button>
            <button id="btnLanguage">Język</button>
            <button id="btnSettings">Ustawienia</button> <!-- Przycisk Ustawienia -->
        </div>
    </div>

    <!-- EKRAN WYBORU DRUŻYN -->
    <div id="teamSelectScreen" class="hidden">
        <h2>Wybierz Drużyny</h2>
        <div class="team-section" id="homeTeamSection">
            <h3>Drużyna Domowa</h3>
            <div id="homeTeamContainer" class="team-container"></div>
        </div>
        <div class="team-section" id="awayTeamSection">
            <h3>Drużyna Gościa</h3>
            <div id="awayTeamContainer" class="team-container"></div>
        </div>
        <button id="startMatchFromSelectBtn">Rozpocznij Mecz</button>
    </div>

    <!-- EKRAN GRY -->
    <div id="gameScreen" class="hidden">
        <div id="scoreboardContainer">
            <h2 id="scoreboard">— : —</h2>
            <h3 id="matchTimer">Czas: 3:00</h3>
        </div>
        <canvas id="gameCanvas" width="800" height="500"></canvas>
        <button id="backToStartBtn">Powrót do Menu</button>
    </div>

    <!-- MODALE -->
    <div id="playerDBModal" class="modal hidden">
        <div class="modal-content">
            <h2>Baza zawodników</h2>
            <div id="playerList"></div>
            <h3>Dodaj zawodnika</h3>
            <form id="addPlayerForm">
                <input type="text" id="playerName" placeholder="Imię i nazwisko" required />
                <input type="text" id="playerTeam" placeholder="Drużyna" required />
                <input type="number" id="playerRating" placeholder="Ocena" required min="0" max="100" />
                <button type="submit">Dodaj</button>
            </form>
            <button id="closePlayerDBBtn" class="close-btn">Zamknij</button> <!-- Dodano klasę close-btn -->
        </div>
    </div>

    <div id="languageModal" class="modal hidden">
        <div class="modal-content">
            <h2>Wybór języka</h2>
            <p>Wybierz język interfejsu:</p>
            <button class="langOption" data-lang="pl">Polski</button>
            <button class="langOption" data-lang="en">English</button>
            <button id="closeLanguageModalBtn" class="close-btn">Zamknij</button> <!-- Dodano klasę close-btn -->
        </div>
    </div>

    <!-- NOWY MODAL: USTAWIEŃ -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content">
            <h2>Ustawienia</h2>
            <div class="font-size-options">
                 <h3>Rozmiar czcionki</h3>
                 <button class="fontSizeOption" data-size="small">Mała</button>
                 <button class="fontSizeOption" data-size="medium">Średnia</button>
                 <button class="fontSizeOption" data-size="large">Duża</button>
            </div>
            <hr> <!-- Linia oddzielająca -->
             <!-- Tutaj można dodać więcej ustawień w przyszłości -->
            <button id="closeSettingsModalBtn" class="close-btn">Zamknij</button> <!-- Dodano klasę close-btn -->
        </div>
    </div>

    <script>
        (function () {
            "use strict";

            // GLOBALNE ZMIENNE I KONSTANTY
            let score = { home: 0, away: 0 };
            let canvas, ctx, ball;
            let fieldPlayers = [];
            let fieldPlayersAway = [];
            let goalkeeper, goalkeeperAway;
            let gameAnimating = false;
            let isDragging = false, draggingPlayerIndex = null;
            let dragStart = { x: 0, y: 0 }, dragCurrent = { x: 0, y: 0 };
            let selectedHomeTeam = null, selectedAwayTeam = null;
            const PLAYER_RADIUS = 16, GOALKEEPER_RADIUS = 18, FRICTION = 0.98, DRAG_IMPULSE_SCALE = 0.05;
            const BALL_COLLISION_IMPULSE = 5; // Dodana stała dla siły odbicia piłki

            // CZAS MECZU
            const MATCH_DURATION = 180;
            let matchTime = MATCH_DURATION;
            let matchTimerInterval = null;

            // Elementy UI
            const startScreen = document.getElementById("startScreen");
            const teamSelectScreen = document.getElementById("teamSelectScreen");
            const gameScreen = document.getElementById("gameScreen");
            const playerDBModal = document.getElementById("playerDBModal");
            const languageModal = document.getElementById("languageModal");
            const settingsModal = document.getElementById("settingsModal"); // Nowy modal

            // --- Funkcje Timera ---
            function updateTimerDisplay() {
                let minutes = Math.floor(matchTime / 60);
                let seconds = matchTime % 60;
                if (seconds < 10) seconds = "0" + seconds;
                document.getElementById("matchTimer").innerText = "Czas: " + minutes + ":" + seconds;
            }
            function startTimer() {
                matchTime = MATCH_DURATION;
                updateTimerDisplay();
                matchTimerInterval = setInterval(() => {
                    matchTime--;
                    updateTimerDisplay();
                    if (matchTime <= 0) {
                        gameOver();
                    }
                }, 1000);
            }
            function stopTimer() {
                clearInterval(matchTimerInterval);
                matchTimerInterval = null;
            }
            function gameOver() {
                stopTimer();
                gameAnimating = false;
                alert("Koniec meczu! Wynik: " + selectedHomeTeam + " " + score.home + " : " + score.away + " " + selectedAwayTeam);
                gameScreen.classList.add("hidden");
                startScreen.classList.remove("hidden");
            }

            // --- Baza Danych Klubów ---
            const teamsData = { /* ... (reszta bez zmian) ... */
                 "Premier League": { leagueLogo: "https://upload.wikimedia.org/wikipedia/en/f/f2/Premier_League_Logo.svg", teams: [ { name: "Manchester United", logo: "https://upload.wikimedia.org/wikipedia/en/7/7a/Manchester_United_FC_crest.svg" }, { name: "Manchester City", logo: "https://upload.wikimedia.org/wikipedia/en/e/eb/Manchester_City_FC_badge.svg" }, { name: "Liverpool", logo: "https://upload.wikimedia.org/wikipedia/en/0/0c/Liverpool_FC.svg" }, { name: "Chelsea", logo: "https://upload.wikimedia.org/wikipedia/en/c/cc/Chelsea_FC.svg" }, { name: "Arsenal", logo: "https://upload.wikimedia.org/wikipedia/en/5/53/Arsenal_FC.svg" }, { name: "Tottenham Hotspur", logo: "https://upload.wikimedia.org/wikipedia/en/b/b4/Tottenham_Hotspur.svg" } ] },
                 "La Liga": { leagueLogo: "https://upload.wikimedia.org/wikipedia/en/9/90/LaLiga.svg", teams: [ { name: "Real Madrid", logo: "https://upload.wikimedia.org/wikipedia/en/5/56/Real_Madrid_CF.svg" }, { name: "Barcelona", logo: "https://upload.wikimedia.org/wikipedia/en/4/47/FC_Barcelona_%28crest%29.svg" }, { name: "Atletico Madrid", logo: "https://brandlogos.net/wp-content/uploads/2021/09/atltico-madrid-logo.png" }, { name: "Sevilla", logo: "https://cdn.freebiesupply.com/logos/large/2x/sevilla-fc-logo-png-transparent.png" }, { name: "Valencia", logo: "https://brandlogos.net/wp-content/uploads/2014/10/valencia_cf-logo_brandlogos.net_iaffl-512x674.png" }, { name: "Villarreal", logo: "https://upload.wikimedia.org/wikipedia/en/thumb/b/b9/Villarreal_CF_logo-en.svg/1200px-Villarreal_CF_logo-en.svg.png" } ] },
                 "Serie A": { leagueLogo: "https://upload.wikimedia.org/wikipedia/en/d/d2/Serie_A_logo_(2019).svg", teams: [ { name: "Juventus", logo: "https://upload.wikimedia.org/wikipedia/commons/d/da/Juventus_Logo.png" }, { name: "Inter Milan", logo: "https://upload.wikimedia.org/wikipedia/commons/0/05/FC_Internazionale_Milano_2021.svg" }, { name: "AC Milan", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d0/Logo_of_AC_Milan.svg/653px-Logo_of_AC_Milan.svg.png" }, { name: "Napoli", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/2d/SSC_Neapel.svg/1200px-SSC_Neapel.svg.png" }, { name: "Roma", logo: "https://upload.wikimedia.org/wikipedia/sco/7/7d/AS_Roma%27s_logo_from_2017.png" }, { name: "Lazio", logo: "https://static.cdnlogo.com/logos/s/89/ss-lazio.png" } ] },
                 "Bundesliga": { leagueLogo: "https://upload.wikimedia.org/wikipedia/commons/d/df/Bundesliga_logo_(2017).svg", teams: [ { name: "Bayern Munich", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/1b/FC_Bayern_M%C3%BCnchen_logo_(2017).svg/2048px-FC_Bayern_M%C3%BCnchen_logo_(2017).svg.png" }, { name: "Borussia Dortmund", logo: "https://upload.wikimedia.org/wikipedia/commons/7/74/Borussia_Dortmund.png" }, { name: "RB Leipzig", logo: "https://upload.wikimedia.org/wikipedia/en/thumb/0/04/RB_Leipzig_2014_logo.svg/1200px-RB_Leipzig_2014_logo.svg.png" }, { name: "Bayer Leverkusen", logo: "https://cdn.freebiesupply.com/logos/large/2x/bayer-leverkusen-logo-png-transparent.png" }, { name: "Eintracht Frankfurt", logo: "https://logodownload.org/wp-content/uploads/2019/11/eintracht-frankfurt-logo.png" }, { name: "Borussia Mönchengladbach", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/81/Borussia_M%C3%B6nchengladbach_logo.svg/1200px-Borussia_M%C3%B6nchengladbach_logo.svg.png" } ] },
                 "Ligue 1": { leagueLogo: "https://upload.wikimedia.org/wikipedia/en/f/fd/Ligue_1.svg", teams: [ { name: "Paris Saint-Germain", logo: "https://logos-world.net/wp-content/uploads/2020/07/PSG-Logo.png" }, { name: "Marseille", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d8/Olympique_Marseille_logo.svg/1582px-Olympique_Marseille_logo.svg.png" }, { name: "Lyon", logo: "https://upload.wikimedia.org/wikipedia/en/thumb/1/1c/Olympique_Lyonnais_logo.svg/1200px-Olympique_Lyonnais_logo.svg.png" }, { name: "Monaco", logo: "https://logodownload.org/wp-content/uploads/2019/09/monaco-fc-logo-1.png" }, { name: "Lille", logo: "https://logodownload.org/wp-content/uploads/2019/09/lille-logo-1.png" }, { name: "Nice", logo: "https://1000logos.net/wp-content/uploads/2020/09/Nice-logo.png" } ] }
            };

            /* Funkcja pomocnicza – zwraca kolor klubowy */
            function getTeamColor(teamName) { /* ... (bez zmian) ... */
                switch(teamName) {
                     case "Manchester United": return "#DA291C"; case "Manchester City": return "#6CABDD"; case "Liverpool": return "#C8102E"; case "Chelsea": return "#034694"; case "Arsenal": return "#EF0107"; case "Tottenham Hotspur": return "#132257"; case "Real Madrid": return "#FEBE10"; /* Zmieniony na złoty */ case "Barcelona": return "#A50044"; case "Atletico Madrid": return "#CB3524"; /* Lekko zmieniony */ case "Sevilla": return "#EC1C24"; case "Valencia": return "#FF8200"; case "Villarreal": return "#FDB913"; case "Juventus": return "#000000"; case "Inter Milan": return "#004D98"; case "AC Milan": return "#DC052D"; case "Napoli": return "#12A0D7"; /* Zmieniony na błękitny */ case "Roma": return "#8E1F2F"; /* Ciemniejszy czerwony */ case "Lazio": return "#85B8D0"; case "Bayern Munich": return "#DC052D"; case "Borussia Dortmund": return "#FDE100"; /* Jaśniejszy żółty */ case "RB Leipzig": return "#00AEEF"; case "Bayer Leverkusen": return "#E32221"; /* Bardziej czerwony */ case "Eintracht Frankfurt": return "#000000"; case "Borussia Mönchengladbach": return "#000000"; case "Paris Saint-Germain": return "#004170"; case "Marseille": return "#0098D6"; /* Jaśniejszy niebieski */ case "Lyon": return "#DA291C"; /* Zmieniony na czerwony */ case "Monaco": return "#E41E2A"; /* Lekko zmieniony czerwony */ case "Lille": return "#E21C24"; /* Zmieniony na czerwony */ case "Nice": return "#ED1C24"; default: return "#777777";
                }
            }

            // --- Funkcje Gry ---
            function initGame() {
                canvas = document.getElementById("gameCanvas");
                if (!canvas) return; // Zabezpieczenie
                ctx = canvas.getContext("2d");
                ball = { x: canvas.width / 2, y: canvas.height / 2, radius: 8, dx: 2, dy: 1.5, color: "white" };
                let homeColor = getTeamColor(selectedHomeTeam);
                let awayColor = getTeamColor(selectedAwayTeam);
                fieldPlayers = [ { x: canvas.width * 0.25, y: canvas.height * 0.3, radius: PLAYER_RADIUS, vx: 0, vy: 0, color: homeColor }, { x: canvas.width * 0.25, y: canvas.height * 0.5, radius: PLAYER_RADIUS, vx: 0, vy: 0, color: homeColor }, { x: canvas.width * 0.25, y: canvas.height * 0.7, radius: PLAYER_RADIUS, vx: 0, vy: 0, color: homeColor }, { x: canvas.width * 0.35, y: canvas.height * 0.5, radius: PLAYER_RADIUS, vx: 0, vy: 0, color: homeColor } ];
                fieldPlayersAway = [ { x: canvas.width * 0.75, y: canvas.height * 0.3, radius: PLAYER_RADIUS, vx: 0, vy: 0, color: awayColor }, { x: canvas.width * 0.75, y: canvas.height * 0.5, radius: PLAYER_RADIUS, vx: 0, vy: 0, color: awayColor }, { x: canvas.width * 0.75, y: canvas.height * 0.7, radius: PLAYER_RADIUS, vx: 0, vy: 0, color: awayColor }, { x: canvas.width * 0.65, y: canvas.height * 0.5, radius: PLAYER_RADIUS, vx: 0, vy: 0, color: awayColor } ];
                goalkeeper = { x: 60, y: canvas.height/2, radius: GOALKEEPER_RADIUS, vx: 0, vy: 0, color: homeColor };
                goalkeeperAway = { x: canvas.width - 60, y: canvas.height/2, radius: GOALKEEPER_RADIUS, vx: 0, vy: 0, color: awayColor };
                score.home = 0; score.away = 0;
            }
            function drawField() { /* ... (bez zmian) ... */
                 ctx.strokeStyle = "#fff"; ctx.lineWidth = 4; ctx.strokeRect(10, 10, canvas.width - 20, canvas.height - 20); ctx.beginPath(); ctx.moveTo(canvas.width/2, 10); ctx.lineTo(canvas.width/2, canvas.height - 10); ctx.stroke(); ctx.fillStyle = "white"; ctx.fillRect(0, canvas.height/2 - 50, 10, 100); ctx.fillRect(canvas.width - 10, canvas.height/2 - 50, 10, 100); ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(10, canvas.height/2 - 50); ctx.lineTo(10, canvas.height/2 + 50); ctx.stroke(); ctx.beginPath(); ctx.moveTo(canvas.width - 10, canvas.height/2 - 50); ctx.lineTo(canvas.width - 10, canvas.height/2 + 50); ctx.stroke(); ctx.strokeRect(10, canvas.height/2 - 80, 60, 160); ctx.strokeRect(canvas.width - 70, canvas.height/2 - 80, 60, 160);
            }
            function drawGameObjects() { /* ... (bez zmian) ... */
                 ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2); ctx.fillStyle = ball.color; ctx.fill(); ctx.closePath();
                 fieldPlayers.forEach(player => { ctx.beginPath(); ctx.arc(player.x, player.y, player.radius, 0, Math.PI*2); ctx.fillStyle = player.color; ctx.fill(); ctx.closePath(); });
                 fieldPlayersAway.forEach(player => { ctx.beginPath(); ctx.arc(player.x, player.y, player.radius, 0, Math.PI*2); ctx.fillStyle = player.color; ctx.fill(); ctx.closePath(); });
                 ctx.beginPath(); ctx.arc(goalkeeper.x, goalkeeper.y, goalkeeper.radius, 0, Math.PI*2); ctx.fillStyle = goalkeeper.color; ctx.fill(); ctx.closePath();
                 ctx.beginPath(); ctx.arc(goalkeeperAway.x, goalkeeperAway.y, goalkeeperAway.radius, 0, Math.PI*2); ctx.fillStyle = goalkeeperAway.color; ctx.fill(); ctx.closePath();
                 if (isDragging && draggingPlayerIndex !== null && dragStart && dragCurrent) { ctx.save(); ctx.setLineDash([5, 5]); ctx.strokeStyle = "red"; ctx.lineWidth = 2; let p = fieldPlayers[draggingPlayerIndex]; let arrowEndX = p.x + (dragStart.x - dragCurrent.x); let arrowEndY = p.y + (dragStart.y - dragCurrent.y); if (!isNaN(arrowEndX) && !isNaN(arrowEndY)) { ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(arrowEndX, arrowEndY); ctx.stroke(); } ctx.restore(); }
            }
            function updatePositions() { /* ... (bez zmian) ... */
                 fieldPlayers.forEach(player => { player.x += player.vx; player.y += player.vy; player.vx *= FRICTION; player.vy *= FRICTION; if (player.x - player.radius < 10) { player.x = 10 + player.radius; player.vx *= -1; } if (player.x + player.radius > canvas.width - 10) { player.x = canvas.width - 10 - player.radius; player.vx *= -1; } if (player.y - player.radius < 10) { player.y = 10 + player.radius; player.vy *= -1; } if (player.y + player.radius > canvas.height - 10) { player.y = canvas.height - 10 - player.radius; player.vy *= -1; } });
                 fieldPlayersAway.forEach(player => { player.x += player.vx; player.y += player.vy; player.vx *= FRICTION; player.vy *= FRICTION; if (player.x - player.radius < 10) { player.x = 10 + player.radius; player.vx *= -1; } if (player.x + player.radius > canvas.width - 10) { player.x = canvas.width - 10 - player.radius; player.vx *= -1; } if (player.y - player.radius < 10) { player.y = 10 + player.radius; player.vy *= -1; } if (player.y + player.radius > canvas.height - 10) { player.y = canvas.height - 10 - player.radius; player.vy *= -1; } });
                 [goalkeeper, goalkeeperAway].forEach(gk => { gk.x += gk.vx; gk.y += gk.vy; gk.vx *= FRICTION; gk.vy *= FRICTION; });
                 ball.x += ball.dx; ball.y += ball.dy; ball.dx *= FRICTION; ball.dy *= FRICTION; if (ball.y - ball.radius < 10) { ball.y = 10 + ball.radius; ball.dy *= -1; } if (ball.y + ball.radius > canvas.height - 10) { ball.y = canvas.height - 10 - ball.radius; ball.dy *= -1; }
                 if (ball.x - ball.radius < 0) { if (ball.y >= canvas.height/2 - 50 && ball.y <= canvas.height/2 + 50) { score.away++; resetBall(); } else { ball.x = 10 + ball.radius; ball.dx *= -1; } }
                 if (ball.x + ball.radius > canvas.width) { if (ball.y >= canvas.height/2 - 50 && ball.y <= canvas.height/2 + 50) { score.home++; resetBall(); } else { ball.x = canvas.width - 10 - ball.radius; ball.dx *= -1; } }
            }
            function resetBall() { /* ... (bez zmian) ... */
                 ball.x = canvas.width / 2; ball.y = canvas.height / 2; ball.dx = 0; ball.dy = 0; ball.color = "white";
                 // Losowy kierunek po resecie (opcjonalnie)
                 // ball.dx = (Math.random() > 0.5 ? 1 : -1) * (Math.random() * 1 + 1);
                 // ball.dy = (Math.random() > 0.5 ? 1 : -1) * (Math.random() * 1 + 1);
            }
            function circleCollision(c1, c2) { /* ... (bez zmian) ... */
                 const dx = c1.x - c2.x; const dy = c1.y - c2.y; return Math.hypot(dx, dy) < (c1.radius + c2.radius);
            }
            function handlePlayerBallCollision(player) { /* ... (zmodyfikowana z BALL_COLLISION_IMPULSE) ... */
                if (circleCollision(player, ball)) {
                    const dx = ball.x - player.x;
                    const dy = ball.y - player.y;
                    const dist = Math.hypot(dx, dy) || 1;
                    // Odbicie piłki od zawodnika
                    ball.dx = (dx / dist) * BALL_COLLISION_IMPULSE;
                    ball.dy = (dy / dist) * BALL_COLLISION_IMPULSE;
                    // Małe odbicie zawodnika (opcjonalnie)
                    player.vx = -(dx / dist) * 0.5;
                    player.vy = -(dy / dist) * 0.5;
                }
            }
            function checkCollisions() { /* ... (bez zmian) ... */
                 fieldPlayers.forEach(player => { handlePlayerBallCollision(player); });
                 fieldPlayersAway.forEach(player => { handlePlayerBallCollision(player); });
                 handlePlayerBallCollision(goalkeeper);
                 handlePlayerBallCollision(goalkeeperAway);
                 // Można dodać kolizje między zawodnikami
            }
            function aiMove() { /* ... (bez zmian, można rozwinąć) ... */
                 fieldPlayersAway.forEach(player => { let dx = ball.x - player.x; let dy = ball.y - player.y; let dist = Math.hypot(dx, dy) || 1; const aiSpeed = 1.5; /* Zmniejszona prędkość AI dla balansu */ player.vx += (dx / dist) * aiSpeed * 0.1; player.vy += (dy / dist) * aiSpeed * 0.1; });
                 let dyGK = ball.y - goalkeeperAway.y; let speedGK = 1.8; /* Lekko zmniejszona prędkość bramkarza */ goalkeeperAway.vy += (dyGK / (Math.abs(dyGK) || 1)) * speedGK * 0.1;
                 // Ograniczenie ruchu bramkarza
                 const goalTop = canvas.height / 2 - 50 + goalkeeperAway.radius;
                 const goalBottom = canvas.height / 2 + 50 - goalkeeperAway.radius;
                 if (goalkeeperAway.y + goalkeeperAway.vy < goalTop) { goalkeeperAway.y = goalTop; goalkeeperAway.vy = 0; }
                 else if (goalkeeperAway.y + goalkeeperAway.vy > goalBottom) { goalkeeperAway.y = goalBottom; goalkeeperAway.vy = 0; }
            }
            function gameLoop() {
                if (!gameAnimating) return;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawField();
                updatePositions();
                checkCollisions();
                // aiMove(); // Przeniesione do mouseUp dla reakcji po ruchu gracza
                drawGameObjects();
                document.getElementById("scoreboard").innerText = selectedHomeTeam + " " + score.home + " : " + score.away + " " + selectedAwayTeam;
                requestAnimationFrame(gameLoop);
            }

            // --- Obsługa Przeciągania ---
            function canvasMouseDown(e) { /* ... (bez zmian) ... */
                 const rect = canvas.getBoundingClientRect(); const mx = e.clientX - rect.left; const my = e.clientY - rect.top;
                 for (let i = 0; i < fieldPlayers.length; i++) { const p = fieldPlayers[i]; if (Math.hypot(mx - p.x, my - p.y) < p.radius) { draggingPlayerIndex = i; isDragging = true; dragStart = { x: p.x, y: p.y }; dragCurrent = { x: mx, y: my }; break; } }
                 // Dodano możliwość przeciągania bramkarza domowego
                 if (!isDragging && Math.hypot(mx - goalkeeper.x, my - goalkeeper.y) < goalkeeper.radius) {
                    draggingPlayerIndex = -1; // Specjalny indeks dla bramkarza
                    isDragging = true; dragStart = { x: goalkeeper.x, y: goalkeeper.y }; dragCurrent = { x: mx, y: my };
                 }
            }
            function canvasMouseMove(e) { /* ... (bez zmian) ... */
                 if (!isDragging) return; const rect = canvas.getBoundingClientRect(); dragCurrent.x = e.clientX - rect.left; dragCurrent.y = e.clientY - rect.top;
            }
            function canvasMouseUp(e) {
                if (!isDragging || draggingPlayerIndex === null) return;
                const dx = dragStart.x - dragCurrent.x;
                const dy = dragStart.y - dragCurrent.y;
                if (draggingPlayerIndex >= 0) { // Zawodnik z pola
                    fieldPlayers[draggingPlayerIndex].vx = dx * DRAG_IMPULSE_SCALE;
                    fieldPlayers[draggingPlayerIndex].vy = dy * DRAG_IMPULSE_SCALE;
                } else if (draggingPlayerIndex === -1) { // Bramkarz domowy
                     goalkeeper.vx = dx * DRAG_IMPULSE_SCALE * 0.8; // Mniejsza siła dla bramkarza
                     goalkeeper.vy = dy * DRAG_IMPULSE_SCALE * 0.8;
                     // Ograniczenie ruchu bramkarza
                     const goalTop = canvas.height / 2 - 50 + goalkeeper.radius;
                     const goalBottom = canvas.height / 2 + 50 - goalkeeper.radius;
                     if (goalkeeper.y + goalkeeper.vy < goalTop) { goalkeeper.y = goalTop; goalkeeper.vy = 0; }
                     else if (goalkeeper.y + goalkeeper.vy > goalBottom) { goalkeeper.y = goalBottom; goalkeeper.vy = 0; }
                }
                isDragging = false;
                draggingPlayerIndex = null;
                aiMove(); // Wywołaj ruch AI po ruchu gracza
            }
            function addCanvasEvents() { /* ... (bez zmian) ... */
                 if (!canvas) return; canvas.addEventListener("mousedown", canvasMouseDown); canvas.addEventListener("mousemove", canvasMouseMove); canvas.addEventListener("mouseup", canvasMouseUp); canvas.addEventListener("mouseleave", canvasMouseUp);
            }

            // --- Wybór Drużyn ---
            function populateTeamSelections() { /* ... (bez zmian) ... */
                 const homeContainer = document.getElementById("homeTeamContainer"); const awayContainer = document.getElementById("awayTeamContainer"); homeContainer.innerHTML = ""; awayContainer.innerHTML = ""; selectedHomeTeam = null; selectedAwayTeam = null;
                 Object.keys(teamsData).forEach(league => {
                     const leagueData = teamsData[league];
                     const createLeagueSection = (container) => {
                         let leagueDiv = document.createElement("div"); leagueDiv.className = "league-section";
                         let leagueHeader = document.createElement("div"); leagueHeader.className = "league-header";
                         let leagueLogo = document.createElement("img"); leagueLogo.src = leagueData.leagueLogo; leagueLogo.alt = league;
                         let leagueName = document.createElement("span"); leagueName.innerText = league;
                         leagueHeader.appendChild(leagueLogo); leagueHeader.appendChild(leagueName); leagueDiv.appendChild(leagueHeader);
                         let teamContainer = document.createElement("div"); teamContainer.className = "team-container";
                         leagueData.teams.forEach(team => {
                             let teamDiv = document.createElement("div"); teamDiv.className = "team-option"; teamDiv.dataset.team = team.name;
                             teamDiv.innerHTML = `<img src="${team.logo}" alt="${team.name}" /><p>${team.name}</p>`;
                             teamDiv.addEventListener("click", function () {
                                 Array.from(container.querySelectorAll('.team-option.selected')).forEach(el => el.classList.remove("selected"));
                                 this.classList.add("selected");
                                 if (container === homeContainer) selectedHomeTeam = team.name;
                                 else selectedAwayTeam = team.name;
                             });
                             teamContainer.appendChild(teamDiv);
                         });
                         leagueDiv.appendChild(teamContainer); container.appendChild(leagueDiv);
                     };
                     createLeagueSection(homeContainer); createLeagueSection(awayContainer);
                 });
            }

            // --- Funkcje Ustawień ---
            const fontSizeOptions = document.querySelectorAll('.fontSizeOption');

            function applyFontSize(size) {
                // Usuń istniejące klasy rozmiaru
                document.body.classList.remove('font-size-small', 'font-size-medium', 'font-size-large');
                // Dodaj nową klasę
                document.body.classList.add(`font-size-${size}`);
                // Zapisz w localStorage
                localStorage.setItem('gameFontSize', size);

                 // Zaktualizuj aktywny przycisk w modalu
                 fontSizeOptions.forEach(button => {
                     button.classList.remove('active-size');
                     if (button.dataset.size === size) {
                         button.classList.add('active-size');
                     }
                 });
                 console.log("Zastosowano rozmiar czcionki:", size);
            }

            function loadFontSize() {
                const savedSize = localStorage.getItem('gameFontSize') || 'medium'; // Domyślnie 'medium'
                applyFontSize(savedSize);
            }

            // --- Główna Inicjalizacja ---
            document.addEventListener("DOMContentLoaded", () => {
                loadFontSize(); // Wczytaj zapisany rozmiar czcionki na starcie

                // Nawigacja ekranów
                document.getElementById("startMatchBtn").addEventListener("click", () => {
                    startScreen.classList.add("hidden");
                    teamSelectScreen.classList.remove("hidden");
                    populateTeamSelections();
                });

                document.getElementById("startMatchFromSelectBtn").addEventListener("click", () => {
                    if (!selectedHomeTeam || !selectedAwayTeam) { alert("Wybierz obie drużyny!"); return; }
                    if (selectedHomeTeam === selectedAwayTeam) { alert("Wybierz dwie różne drużyny!"); return; }
                    console.log("Wybrane drużyny:", selectedHomeTeam, "-", selectedAwayTeam);
                    teamSelectScreen.classList.add("hidden");
                    gameScreen.classList.remove("hidden");
                    initGame();
                    addCanvasEvents();
                    startTimer();
                    gameAnimating = true;
                    requestAnimationFrame(gameLoop);
                });

                document.getElementById("backToStartBtn").addEventListener("click", () => {
                    gameAnimating = false;
                    stopTimer();
                    gameScreen.classList.add("hidden");
                    startScreen.classList.remove("hidden");
                });

                // Obsługa modali
                document.getElementById("btnPlayerDB").addEventListener("click", () => playerDBModal.classList.remove("hidden"));
                document.getElementById("closePlayerDBBtn").addEventListener("click", () => playerDBModal.classList.add("hidden"));
                document.getElementById("btnLanguage").addEventListener("click", () => languageModal.classList.remove("hidden"));
                document.getElementById("closeLanguageModalBtn").addEventListener("click", () => languageModal.classList.add("hidden"));

                // NOWE: Obsługa modala Ustawień
                document.getElementById("btnSettings").addEventListener("click", () => {
                     settingsModal.classList.remove("hidden");
                     // Ustaw aktywny przycisk na podstawie aktualnej klasy body
                     const currentSize = localStorage.getItem('gameFontSize') || 'medium';
                     fontSizeOptions.forEach(button => {
                         button.classList.toggle('active-size', button.dataset.size === currentSize);
                     });
                });
                document.getElementById("closeSettingsModalBtn").addEventListener("click", () => settingsModal.classList.add("hidden"));

                 // NOWE: Obsługa przycisków zmiany rozmiaru czcionki
                 fontSizeOptions.forEach(button => {
                     button.addEventListener('click', () => {
                         applyFontSize(button.dataset.size);
                     });
                 });

                // Obsługa formularza dodawania gracza (jeśli istnieje)
                const addPlayerForm = document.getElementById("addPlayerForm");
                if(addPlayerForm) {
                    addPlayerForm.addEventListener("submit", (e) => {
                        e.preventDefault();
                        // Tutaj logika dodawania gracza
                        console.log("Dodawanie gracza...");
                        // wyczyść formularz
                        e.target.reset();
                    });
                }

                 // Obsługa zmiany języka (jeśli istnieje)
                 const langOptions = document.querySelectorAll(".langOption");
                 langOptions.forEach(button => {
                     button.addEventListener("click", () => {
                         const lang = button.dataset.lang;
                         console.log("Zmieniono język na:", lang);
                         // Tutaj można dodać logikę zmiany języka interfejsu
                         languageModal.classList.add("hidden"); // Zamknij modal po wyborze
                     });
                 });

            });

        })();
    </script>
</body>
</html>
